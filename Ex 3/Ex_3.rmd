---
title: "Ex 3 :"
author: "To be determined"
date: "2025-11-27"
output: html_document
---

```{r setup, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)

packages <- c("readxl", "dplyr","tidyverse", "dynlm", "FinTS","lmtest", "tseries", "nonlinearTseries", "MSwM", "tsDyn", "rugarch", "rmgarch")
lapply(packages, require, character.only = TRUE)

bonds = read_excel("../datasets/base_bond_equity.xls", sheet = "Bonds")

# Inspect column names
colnames(bonds)

```

```{r}
# Construct yield spreads vs Germany
bonds <- bonds %>%
  mutate(
    AUT_spread = bonds$`Austria, Government Benchmarks, Macrobond, 10 Year, Yield` - bonds$`Germany, Government Benchmarks, Macrobond, 10 Year, Yield`,
    SPA_spread = bonds$`Spain, Government Benchmarks, Macrobond, 10 Year, Yield` - bonds$`Germany, Government Benchmarks, Macrobond, 10 Year, Yield`
  ) %>%
  drop_na()

# Convert to time series
AUT_spread <- ts(bonds$AUT_spread, frequency = 12)
SPA_spread <- ts(bonds$SPA_spread, frequency = 12)
```

## 1°/ Markov-Switching Model :
### 1.1°/ Linear benchmark model :

```{r}
# Start with 1 lag
lin_mod <- lm(AUT_spread ~ stats::lag(SPA_spread, 1))
summary(lin_mod)

# Autocorrelation
bgtest(lin_mod, order = 4)

# ARCH effects
ArchTest(residuals(lin_mod), lags = 5)

# Normality
jarque.bera.test(residuals(lin_mod))
```

### 1.2°/ Markov-Switching regression (2 regimes) :

```{r}
AICs <- c()

for (p in 1:4) {
  mod <- lm(AUT_spread ~ stats::lag(SPA_spread, -p))
  AICs[p] <- AIC(mod)
}

which.min(AICs)

bonds$lagged_SPA_spread <- stats::lag(bonds$SPA_spread, 1)

bonds2 <- na.omit(bonds)

ms_mod <- msmFit(
  lm(AUT_spread ~ lagged_SPA_spread, data = bonds2),
  k = 2,
  control = list(parallel = FALSE),
  sw = c(TRUE, TRUE, TRUE)  # intercept, slope, variance switch
)

summary(ms_mod)
```

### 1.3°/ Posterior regim probabilities :
```{r}
plot(ms_mod@Fit@smoProb[,1],
     type = "l", col = "blue",
     main = "Smoothed Probability – Regime 1",
     ylab = "Probability")

plot(ms_mod@Fit@smoProb[,2],
     type = "l", col = "red",
     main = "Smoothed Probability – Regime 2",
     ylab = "Probability")
```

## 2°/ LSTAR Model :
### 2.1°/ Linearity test :

```{r}
lin_model <- lm(AUT_spread ~ stats::lag(AUT_spread, 1))

plot(resid(lin_model))

residuals <- resid(lin_model)

nonlinearityTest(residuals,verbose=TRUE)
```

### 2.2 LSTAR model :

```{r}
lstar_mod <- lstar(
  bonds$AUT_spread,
  m = 1,
  d = 1,
  control = list(trace = TRUE)
)

summary(lstar_mod)
```

```{r}
pdf_file <- "lstar_transition.pdf"

if (file.exists(pdf_file)) {
  # Open the existing PDF
  if (.Platform$OS.type == "windows") {
    shell.exec(pdf_file)
  } else if (Sys.info()["sysname"] == "Darwin") {
    system(paste("open", pdf_file))
  } else {
    system(paste("xdg-open", pdf_file))
  }
} else {
  # Create the PDF
  pdf(pdf_file)
  plot(lstar_mod, which = "transition")
  dev.off()
}
```

## 3°/ Bivariate GARCH :
### 3.1°/ Specify univariate GARCH :

```{r}
spec_uni <- ugarchspec(
  variance.model = list(model = "sGARCH"),
  mean.model = list(armaOrder = c(1,0)),
  distribution.model = "norm"
)
```

### 3.2°/ GARCH specification :

```{r}
spec_dcc <- dccspec(
  uspec = multispec(replicate(2, spec_uni)),
  dccOrder = c(1,1),
  distribution = "mvnorm"
)

data_mat <- cbind(AUT_spread, SPA_spread)

dcc_fit <- dccfit(spec_dcc, data = data_mat)
summary(dcc_fit)
```

### 3.3 Dynamic correlation plot :

```{r}
dcc_cor <- rcor(dcc_fit)
plot(dcc_cor[1,2,],
     type = "l",
     main = "Dynamic Correlation: Austria–Spain",
     ylab = "Correlation")
```

