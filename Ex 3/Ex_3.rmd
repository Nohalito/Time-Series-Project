---
title: "Ex 3 :"
author: "Noha"
date: "2025-11-27"
output: html_document
---

```{r setup, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require("pacman")) install.packages("pacman")

pacman::p_load(readxl, dplyr, tidyverse, dynlm, xts, FinTS, lmtest, tseries, nonlinearTseries, MSwM, tsDyn ,rugarch, rmgarch)
packages <- c("readxl", "dplyr","tidyverse", "dynlm", "xts", "FinTS", "lmtest", "tseries", "nonlinearTseries", "MSwM", "tsDyn", "rugarch", "rmgarch")
lapply(packages, require, character.only = TRUE)

data = read_excel("../datasets/base_bond_equity.xls", sheet = "Bonds")

# Inspect column names
colnames(data)
```

```{r}
# Construct yield spreads vs Germany
data <- data %>%
  mutate(
    AUT_spread = data$`Austria, Government Benchmarks, Macrobond, 10 Year, Yield` - data$`Germany, Government Benchmarks, Macrobond, 10 Year, Yield`,
    SPA_spread = data$`Spain, Government Benchmarks, Macrobond, 10 Year, Yield` - data$`Germany, Government Benchmarks, Macrobond, 10 Year, Yield`
  ) %>%
  drop_na()

# Convert to time series
AUT_spread<-xts(data$AUT_spread, order.by = data$Date...7 )
SPA_spread<-xts(data$SPA_spread, order.by = data$Date...39 )

RAUT_spread = diff(log(AUT_spread), lag = 1, differences = 1)
RSPA_spread = diff(log(SPA_spread), lag = 1, differences = 1)

#AUT_spread <- ts(data$AUT_spread, frequency = 12)
#SPA_spread <- ts(data$SPA_spread, frequency = 12)

df = cbind(AUT_spread, SPA_spread)
log_df = cbind(RAUT_spread, RSPA_spread)

plot(ts(df))
plot(ts(log_df))
```

## 1°/ Markov-Switching Model :
### 1.1°/ Linear benchmark model :

```{r}
# Start with 1 lag
lin_mod <- lm(AUT_spread ~ stats::lag(SPA_spread, 1))
summary(lin_mod)

par(mfrow=c(2,2))
plot(lin_mod)
```

```{r}
# Autocorrelation
bgtest(lin_mod, order = 4)

# ARCH effects
ArchTest(residuals(lin_mod), lags = 5)

# Normality
jarque.bera.test(residuals(lin_mod))
```

### 1.2°/ Markov-Switching regression (2 regimes) :

```{r}
AICs <- c()

for (p in 1:4) {
  mod <- lm(RAUT_spread ~ stats::lag(RSPA_spread, -p))
  AICs[p] <- AIC(mod)
}

which.min(AICs)

data$lagged_SPA_spread <- stats::lag(data$RSPA_spread, 1)

data <- na.omit(data)

ms_mod <- msmFit(
  lm(RAUT_spread ~ lagged_SPA_spread, data = data),
  k = 2,
  control = list(parallel = FALSE),
  sw = c(TRUE, TRUE, TRUE)  # intercept, slope, variance switch
)

summary(ms_mod)
```

### 1.3°/ Posterior regim probabilities :
```{r}
par(mfrow = c(1, 2))

plot(ms_mod@Fit@smoProb[,1],
     type = "l", col = "blue",
     main = "Smoothed Probability – Regime 1",
     ylab = "Probability")

plot(ms_mod@Fit@smoProb[,2],
     type = "l", col = "red",
     main = "Smoothed Probability – Regime 2",
     ylab = "Probability")
```

## 2°/ LSTAR Model :
### 2.1°/ Linearity test :

```{r}
par(mfrow = c(2,2))
plot(lin_mod)
```

### 2.2 LSTAR model :

```{r}
lstar_mod <- tsDyn::lstar(
  AUT_spread,
  m = 1,
  d = 1,
  control = list(trace = TRUE)
)

summary(lstar_mod)
```

## 3°/ Bivariate GARCH :
### 3.1°/ Specify univariate GARCH :

```{r}
spec_uni <- ugarchspec(
  variance.model = list(model = "sGARCH"),
  mean.model = list(armaOrder = c(1,0)),
  distribution.model = "norm"
)
```

### 3.2°/ GARCH specification :

```{r}
spec_dcc <- dccspec(
  uspec = multispec(replicate(2, spec_uni)),
  dccOrder = c(1,1),
  distribution = "mvnorm"
)

#data_mat <- cbind(AUT_spread, SPA_spread)

dcc_fit <- dccfit(spec_dcc, data = df)
summary(dcc_fit)
```

### 3.3 Dynamic correlation plot :

```{r}
dcc_cor <- rcor(dcc_fit)
plot(dcc_cor[1,2,],
     type = "l",
     main = "Dynamic Correlation: Austria–Spain",
     ylab = "Correlation")
```

