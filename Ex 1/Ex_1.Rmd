---
title: "Ex 1 :"
author: "Nohalito"
date: "2025-11-27"
output: pdf_document
---

```{r setup, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require("pacman")) install.packages("pacman")

pacman::p_load(readxl, moments, ggplot2, patchwork, fitdistrplus, evd, extRemes, copula, PerformanceAnalytics, tseries)

packages <- c("readxl", "moments", "ggplot2", "patchwork", "fitdistrplus", "evd", "extRemes",
              "copula", "PerformanceAnalytics", "tseries")
lapply(packages, require, character.only = TRUE)
```
## 1°/ Data extraction :

```{r data, include = FALSE}
data = read_excel('../datasets/capm.xls', skip = 1)

# Construct excess returns 
asset <- "MICROSOFT"

# Excess returns
asset_returns = diff(log(cbind(data[[asset]])), lag = 1)
market_returns = diff(log(cbind(data$SANDP)), lag = 1)
risk_free_returns = diff(log(cbind(data$USTB3M)), lag = 1)

asset_excess = asset_returns - risk_free_returns
market_excess = market_returns - risk_free_returns

# Remove NA
df <- na.omit(data.frame(asset_excess, market_excess))

head(data)
```

```{r}
# Basic stats
summary(df)

# Moments
apply(df, 2, skewness)
apply(df, 2, kurtosis)
```

## 2°/ EDA :
### 2.1°/ Distribution plot :

```{r}
p1 <- ggplot(df, aes(x = asset_excess)) +
  geom_histogram(aes(y = ..density..), bins = 40, fill = "grey") +
  geom_density(color = "blue") +
  ggtitle("Asset Excess Returns")

p2 <- ggplot(df, aes(x = market_excess)) +
  geom_histogram(aes(y = ..density..), bins = 40, fill = "grey") +
  geom_density(color = "red") +
  ggtitle("Market Excess Returns")

(p1 | p2) +
  plot_annotation(
    title = "Distribution & Histograms of : "
  ) &
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )
```

### 2.2°/ QQ-plot :

```{r}
# Touche moi le QQ-plot
par(mfrow = c(1, 2))

qqnorm(df$asset_excess) +
  qqline(df$asset_excess, col = "red")

qqnorm(df$market_excess) +
  qqline(df$market_excess, col = "red")
```

### 2.3°/ Box-plot :

```{r}
par(mfrow = c(1, 2))

boxplot(df$asset_excess, main = "Boxplot – Asset Excess Returns")
boxplot(df$market_excess, main = "Boxplot – Market Excess Returns")
```

### 2.4°/ Time series plot :

```{r}
plot(ts(df), main = "Time Series of Asset & Market excess returns" )
```

### 2.5°/ ACF :

```{r}
par(mfrow = c(1, 2))
acf(df$asset_excess, main = "ACF – Asset Excess Returns")
acf(df$market_excess, main = "ACF – Market Excess Returns")
```

### 2.6°/ PP-plot :

```{r}
ppplot <- function(x, string) {
  n <- length(x)
  y <- sort(x)
  p <- pnorm(y, mean(x), sd(x))
  plot((1:n)/(n+1), p, main=string)
  abline(0,1,col="red")
}

par(mfrow = c(1, 2))
ppplot(df$asset_excess, "Asset pp-plot")
ppplot(df$market_excess, "Market pp-plot")
```

### 2.7°/ Bivariate scatterplot :

```{r}
plot(df$market_excess, df$asset_excess,
     xlab = "Market Excess Returns",
     ylab = "Asset Excess Returns",
     main = "Bivariate Scatterplot")
```

## 3°/ Fit an extreme distribution :

```{r}
# Whatever the distribution, we need positive data => ofc I (don't) listen in class so I missed that part.
x <- df$asset_excess # Should I put '-' before it ?
x <- x[x > 0]  # focus on losses

# We ballin' on Redbull distribution :
fit_weibull <- fitdist(x, "weibull")
summary(fit_weibull)
plot(fit_weibull)
```

## 4°/ Fit the GEV distribution :

```{r}
# Fuck it, we rollin' on evd library instead
gev_fit <- fgev(df$asset_excess)
summary(gev_fit)
```

### 4.1°/ GEV QQ-plot :

```{r}
# Extract fitted parameters
params <- gev_fit$estimate

# Compute the theoretical quantiles from the fitted GEV distribution
theoretical_quantiles <- qgev(ppoints(length(df$asset_excess)), loc = params[1], scale = params[2], shape = params[3])

# Create the QQ plot manually
qqplot(theoretical_quantiles, df$asset_excess)
```

### 4.2°/ GEV Density :

```{r}
plot(gev_fit, 3)
```

### 4.3°/ GEV Probability

```{r}
plot(gev_fit, 1)
```

## 5 : Elliptical copulas :
```{r}
u_asset  <- rank(df$asset_excess)/(nrow(df)+1)
u_market <- rank(df$market_excess)/(nrow(df)+1)

U <- cbind(u_asset, u_market)
```

```{r}
gauss_cop <- normalCopula(dim = 2)
fit_gauss <- fitCopula(gauss_cop, U, method = "ml")
summary(fit_gauss)
```

## 6°/ Archimedean copulas : Clayton :

```{r}
clayton <- claytonCopula(dim = 2)
fit_clayton <- fitCopula(clayton, U, method = "ml")
summary(fit_clayton)
```

