---
title: "Exercise 2: Regime-switching models"
author: "khalil akchi"
date: "2025-12-29"
output: html_document
---

```{r setup, include=FALSE}
# Allow errors to ensure the PDF/HTML generates even if one model struggles
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = TRUE)

# Auto-install and load packages
packages <- c("readxl", "MSwM", "tsDyn", "tseries", "lmtest", "zoo", "TTR")
new_packages <- packages[!(packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)
lapply(packages, require, character.only = TRUE)
```



```{r}
# --- Question 1: Markov-Switching Model ---

# Load necessary libraries
# install.packages(c("readxl", "MSwM", "tseries", "zoo", "dplyr"))
library(readxl)
library(MSwM)
library(tseries)
library(zoo)
library(dplyr)

# 1. Data Loading and Transformation
# ----------------------------------
# We read the file (assuming it's in the project folder)
# Note: 'skip=1' skips the first row of headers to get the correct column names
df_raw <- read_excel("../datasets/capm.xls", skip = 1)

# Convert Excel serial date to Date object
df_raw$Date <- as.Date(df_raw$Date, origin = "1899-12-30")

# Calculate Returns (Log-Difference * 100)
# We calculate returns for all columns except Date and RiskFree
# Note: diff(log(x)) * 100
price_cols <- c("SANDP", "FORD", "GE", "MICROSOFT", "ORACLE")
returns_df <- df_raw %>%
  select(Date, all_of(price_cols), USTB3M) %>%
  mutate(across(all_of(price_cols), ~ c(NA, diff(log(.)) * 100)))

# Calculate Excess Returns
# Risk Free Rate is annual % (USTB3M), convert to monthly by dividing by 12
returns_df$Rf_Monthly <- returns_df$USTB3M / 12

# Create Excess Returns columns
df_excess <- returns_df %>%
  mutate(
    Excess_Market = SANDP - Rf_Monthly,
    Excess_Microsoft = MICROSOFT - Rf_Monthly,
    Excess_Ford = FORD - Rf_Monthly,
    Excess_GE = GE - Rf_Monthly,
    Excess_Oracle = ORACLE - Rf_Monthly
  ) %>%
  na.omit() # Remove the first row created by differencing

# Select Asset for Analysis (Let's use MICROSOFT as per your previous code)
asset_excess <- df_excess$Excess_Microsoft
market_excess <- df_excess$Excess_Market

# 2. Linear Model & Non-Linearity Testing
# ---------------------------------------
cat("\n--- A. Linear Model Estimation ---\n")
linear_model <- lm(asset_excess ~ market_excess)
print(summary(linear_model))

# Test for Non-Linearity (BDS Test on Residuals)
# H0: Residuals are i.i.d. (Linear model is sufficient)
# H1: Residuals are not i.i.d. (Non-linear structure exists)
cat("\n--- B. BDS Test for Non-Linearity ---\n")
u_linear <- residuals(linear_model)
bds_res <- bds.test(u_linear, m = 3) # Embedding dimension 3 is standard
print(bds_res)

# 3. Markov-Switching Model Selection (Lag Selection)
# ---------------------------------------------------
# --- C. MS Model Lag Selection (AIC) - FIXED ---
library(dplyr)

# Model 0: No Lags (Standard CAPM)
# Variables: Intercept, Market_Excess. Variance switches.
mod0 <- lm(asset_excess ~ market_excess)
ms_0 <- msmFit(mod0, k = 2, sw = c(TRUE, TRUE, TRUE), control = list(parallel = FALSE)) 

# Model 1: Lag 1
# We use dplyr::lag to correctly shift the data
df_lags <- data.frame(
  Y = asset_excess,
  X0 = market_excess,
  X1 = dplyr::lag(market_excess, 1) # Lag 1
)
# Remove NAs created by lag
df_lags <- na.omit(df_lags)

# Fit Linear Model for Lag 1
mod1 <- lm(Y ~ X0 + X1, data = df_lags)

# Fit MS Model
# sw has 4 TRUEs: Intercept, X0, X1, Variance
ms_1 <- msmFit(mod1, k = 2, sw = rep(TRUE, 4), control = list(parallel = FALSE))

# Compare AIC
cat("AIC Model 0 (No Lags):", AIC(ms_0), "\n")
cat("AIC Model 1 (1 Lag):  ", AIC(ms_1), "\n")

# --- D. Final Model & Plotting ---
# Automatically select the best model
if (AIC(ms_0) < AIC(ms_1)) {
  best_model <- ms_0
  cat("\nSelected Model: Model 0 (Standard CAPM)\n")
} else {
  best_model <- ms_1
  cat("\nSelected Model: Model 1 (Lagged Market)\n")
}

print(summary(best_model))

# Plot Posterior Probabilities
par(mar = c(2, 2, 2, 2)) # Reduces margins to 2 lines on all sides
plotProb(best_model, which = 1)
title(main = "Posterior Probabilities of Regime 1")
```

### Interpretation of Markov-Switching Results

#### 1. Evidence of Non-Linearity (BDS Test)
The **BDS Test** on the residuals of the linear model provides marginal evidence of non-linearity.
* At embedding dimension 3 (epsilon $\approx$ 10.7), the p-value is **0.0474** ($< 0.05$).
* This rejection of the null hypothesis (i.i.d. residuals) justifies exploring non-linear specifications like the Markov-Switching model, as simple linear dependence does not fully capture the data structure.

#### 2. Model Selection (AIC)
We compared a standard Switching CAPM (Model 0) against one including lagged market returns (Model 1).
* **Model 0 AIC:** 836.23
* **Model 1 AIC:** 828.16
* **Decision:** The lower AIC for **Model 1** suggests that including the lagged market return improves the model fit. We proceed with Model 1.

#### 3. Regime Identification
The estimated model identifies two distinct market regimes:

* **Regime 1 (High Volatility / "Defensive"):**
    * **Volatility:** High ($\sigma \approx 5.89$).
    * **Market Sensitivity ($\beta$):** Low ($0.59$).
    * **Interpretation:** This likely corresponds to volatile or crisis periods where the asset decouples somewhat from the market (acting defensively) but faces high idiosyncratic risk. The low $R^2$ (0.30) suggests market movements explain less of the asset's behavior in this state.

* **Regime 2 (Low Volatility / "Aggressive"):**
    * **Volatility:** Low ($\sigma \approx 2.90$).
    * **Market Sensitivity ($\beta$):** High ($1.35$).
    * **Interpretation:** This corresponds to stable "bull" markets. The asset acts as an aggressive growth stock ($\beta > 1$), amplifying market gains. The high $R^2$ (0.82) indicates the CAPM holds very well in this regime.

* **Posterior Probabilities:** The plot confirms distinct switching behavior, with the economy spending significant time in the stable Regime 2, interspersed with spikes into the volatile Regime 1.


## 2.STAR Model


```{r}
# --- Question 2: STAR Model Estimation ---
library(tsDyn)

cat("\n=========================================\n")
cat("   STAR MODEL ANALYSIS\n")
cat("=========================================\n")

# 1. Prepare Data
# We use Microsoft Excess Returns as the Dependent Variable (Y)
# We use Market Excess Returns as the Transition Variable (Z)
y_ts <- ts(asset_excess)
th_ts <- ts(market_excess) # Transition variable

# 2. Linearity Test & Model Selection
# We use 'selectSETAR' to test linearity against threshold models.
# - m=1: Auto-regressive order (AR(1))
# - thVar: We use the external Market variable
# - d=1:4: We test delays of 1 to 4 months for the transition variable
cat("\n--- A. Testing Linearity & Selecting Delay (d) ---\n")
selection_test <- selectSETAR(y_ts, m=1, thVar=th_ts, d=1:4, criterion="AIC")
print(selection_test)

# 3. Estimate LSTAR Model
# Based on the test, we typically choose the model with the lowest AIC.
# We will assume LSTAR is preferred (common in asset pricing).
# We use d=1 (Market lag 1) as the transition variable unless the test says otherwise.

cat("\n--- B. Estimating LSTAR Model ---\n")
# Note: m=1 means Y_t depends on Y_{t-1}. 
# thVar means the *regime* depends on the Market.
star_mod <- lstar(y_ts, m = 1, thVar = th_ts, d = 1, control = list(maxit = 3000))
print(summary(star_mod))

# 4. Graphical Representation
cat("\n--- C. Transition Function Plot ---\n")
# This plots the transition function (Gamma) against the Market Return
# It shows how the parameters change as the market moves from negative to positive.
tryCatch({
  plot(star_mod)
}, error = function(e) {
  cat("Standard plot failed. Plotting Transition Variable instead.\n")
  plot(th_ts, main="Transition Variable (Market Excess)")
})
```


### Question 2: Smooth Transition AutoRegressive (STAR) Model

#### 1. Linearity Testing & Model Estimation
We estimated an LSTAR (Logistic STAR) model using the lagged Market Excess Return as the transition variable ($d=1$).
* **Threshold Value:** The estimated threshold is **-5.62%**. This suggests the model tries to split the data into two regimes: extremely negative market months (crashes below -5.62%) and "normal" months.
* **Smoothing Parameter ($\gamma$):** The estimated Gamma is **100**. A value this high indicates that the transition is **not smooth** but abrupt. The Logistic function effectively becomes a Step function, making this LSTAR model behave almost exactly like a Threshold (SETAR) or Regime-Switching model.

#### 2. Statistical Significance
* **Non-Linearity Test:** The test of the LSTAR model against a linear AR model yields a **p-value of 0.935**.
* **Conclusion:** We **cannot reject the null hypothesis of linearity**.
    * This means that statistically, the complex LSTAR model does not provide a significantly better fit than a simple linear model for this specific asset.
    * The extremely high Gamma and insignificant p-value suggest that while there might be structural breaks (as seen in the Markov-Switching model in Q1), a smooth transition based *only* on the previous month's market return is not the correct specification.

#### 3. Graphical Representation
The standard transition plot failed because the transition is so abrupt ($\gamma=100$) that it looks like a vertical line rather than an S-curve. This confirms our finding that the "Smooth" part of the STAR model is not present in this data.
